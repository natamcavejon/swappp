{"version":3,"file":"index.js","names":["require","config","initServer","serverOptions","mergeDeep","setMaxListners","logger","createLogger","log","app","express","PORT","process","env","port","http","createServer","io","Socket","cors","origins","use","json","limit","urlencoded","extended","static","boolParser","req","res","next","oldSend","send","data","content","headers","JSON","parse","session","client","mapper","enable","response","convert","prefix","on","sock","info","id","routes","createFolders","listen","host","version","startAllSession","startAllSessions"],"sources":["../src/index.js"],"sourcesContent":["/*\n * Copyright 2021 WPPConnect Team\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nrequire('dotenv').config();\n\nimport { createLogger } from './util/logger';\nimport { createFolders, setMaxListners, startAllSessions } from './util/functions';\nimport cors from 'cors';\nimport express from 'express';\nimport { createServer } from 'http';\nimport { Server as Socket } from 'socket.io';\nimport routes from './routes';\nimport config from './config.json';\nimport boolParser from 'express-query-boolean';\nimport mergeDeep from 'merge-deep';\nimport { convert } from './mapper/index';\nimport { version } from '../package.json';\n\nexport function initServer(serverOptions) {\n  if (typeof serverOptions !== 'object') {\n    serverOptions = {};\n  }\n\n  serverOptions = mergeDeep({}, config, serverOptions);\n\n  setMaxListners(serverOptions);\n\n  const logger = createLogger(serverOptions.log);\n\n  const app = express();\n  const PORT = process.env.PORT || serverOptions.port;\n\n  const http = new createServer(app);\n  const io = new Socket(http, {\n    cors: true,\n    origins: ['*'],\n  });\n\n  app.use(cors());\n  app.use(express.json({ limit: '50mb' }));\n  app.use(express.urlencoded({ limit: '50mb', extended: true }));\n  app.use('/files', express.static('WhatsAppImages'));\n  app.use(boolParser());\n\n  // Add request options\n  app.use((req, res, next) => {\n    req.serverOptions = serverOptions;\n    req.logger = logger;\n    req.io = io;\n\n    var oldSend = res.send;\n\n    res.send = async function (data) {\n      const content = req.headers['content-type'];\n      if (content == 'application/json') {\n        data = JSON.parse(data);\n        if (!data.session) data.session = req.client ? req.client.session : '';\n        if (data.mapper && req.serverOptions.mapper.enable) {\n          data.response = await convert(req.serverOptions.mapper.prefix, data.response, data.mapper);\n          delete data.mapper;\n        }\n      }\n      res.send = oldSend;\n      return res.send(data);\n    };\n    next();\n  });\n\n  io.on('connection', (sock) => {\n    logger.info(`ID: ${sock.id} entrou`);\n\n    sock.on('disconnect', () => {\n      logger.info(`ID: ${sock.id} saiu`);\n    });\n  });\n\n  app.use(routes);\n\n  createFolders();\n\n  http.listen(PORT, () => {\n    logger.info(`Server is running on port: ${PORT}`);\n    logger.info(`\\x1b[31m Visit ${serverOptions.host}:${PORT}/api-docs for Swagger docs`);\n    logger.info(`WPPConnect-Server version: ${version}`);\n\n    if (serverOptions.startAllSession) startAllSessions(serverOptions, logger);\n  });\n\n  return {\n    app,\n    routes,\n    logger,\n  };\n}\n"],"mappings":"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"}