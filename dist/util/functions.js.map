{"version":3,"file":"functions.js","names":["mime","config","webhook","uploadS3","require","crypto","aws","contactToArray","number","isGroup","localArr","Array","isArray","contact","split","replace","push","arrContacts","groupToArray","group","groupNameToArray","callWebHook","client","req","event","data","serverOptions","url","autoDownload","chatId","from","_serialized","Object","assign","session","mapper","enable","convert","prefix","api","post","then","events","includes","readMessage","sendSeen","e","catch","logger","warn","error","message","isMedia","isMMS","buffer","decryptFile","hashName","randomBytes","toString","fileName","extension","mimetype","s3","S3","params","Bucket","Key","Body","ACL","ContentType","upload","promise","fileUrl","Location","body","startAllSessions","host","port","secretKey","startHelper","allUnreadOnStart","sendUnread","archive","info","chats","getAllChatsWithMessages","length","i","j","msgs","ex","sleep","time","Promise","resolve","setTimeout","getAllChats","filter","c","date","Date","t","DaysBetween","daysToArchive","archiveChat","id","Math","floor","random","waitTime","StartDate","endDate","oneDay","start","UTC","getFullYear","getMonth","getDate","end","createFolders","__dirname","path","dirname","dirFiles","fs","existsSync","mkdirSync","dirUpload","strToBool","s","test","getIPAddress","interfaces","networkInterfaces","devName","iface","alias","family","address","internal","setMaxListners","Number","isInteger","maxListeners","process","setMaxListeners","unlinkAsync","promisify","unlink","createCatalogLink","wid"],"sources":["../../src/util/functions.js"],"sourcesContent":["/*\n * Copyright 2021 WPPConnect Team\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport api from 'axios';\nimport path from 'path';\nimport fs from 'fs';\nimport { promisify } from 'util';\nimport { convert } from '../mapper/index';\nimport config from '../config.json';\n\nlet mime = config.webhook.uploadS3 ? require('mime-types') : null;\nlet crypto = config.webhook.uploadS3 ? require('crypto') : null;\nlet aws = config.webhook.uploadS3 ? require('aws-sdk') : null;\n\nexport function contactToArray(number, isGroup) {\n  let localArr = [];\n  if (Array.isArray(number)) {\n    for (let contact of number) {\n      isGroup ? (contact = contact.split('@')[0]) : (contact = contact.split('@')[0]?.replace(/[^\\w ]/g, ''));\n      if (contact !== '')\n        if (isGroup) localArr.push(`${contact}@g.us`);\n        else localArr.push(`${contact}@c.us`);\n    }\n  } else {\n    let arrContacts = number.split(/\\s*[,;]\\s*/g);\n    for (let contact of arrContacts) {\n      isGroup ? (contact = contact.split('@')[0]) : (contact = contact.split('@')[0]?.replace(/[^\\w ]/g, ''));\n      if (contact !== '')\n        if (isGroup) localArr.push(`${contact}@g.us`);\n        else localArr.push(`${contact}@c.us`);\n    }\n  }\n\n  return localArr;\n}\n\nexport function groupToArray(group) {\n  let localArr = [];\n  if (Array.isArray(group)) {\n    for (let contact of group) {\n      contact = contact.split('@')[0];\n      if (contact !== '') localArr.push(`${contact}@g.us`);\n    }\n  } else {\n    let arrContacts = group.split(/\\s*[,;]\\s*/g);\n    for (let contact of arrContacts) {\n      contact = contact.split('@')[0];\n      if (contact !== '') localArr.push(`${contact}@g.us`);\n    }\n  }\n\n  return localArr;\n}\n\nexport function groupNameToArray(group) {\n  let localArr = [];\n  if (Array.isArray(group)) {\n    for (const contact of group) {\n      if (contact !== '') localArr.push(`${contact}`);\n    }\n  } else {\n    let arrContacts = group.split(/\\s*[,;]\\s*/g);\n    for (const contact of arrContacts) {\n      if (contact !== '') localArr.push(`${contact}`);\n    }\n  }\n\n  return localArr;\n}\n\nexport async function callWebHook(client, req, event, data) {\n  const webhook = client?.config.webhook || req.serverOptions.webhook.url || false;\n  if (webhook) {\n    if (req.serverOptions.webhook.autoDownload) await autoDownload(client, req, data);\n    try {\n      const chatId = data.from || data.chatId || (data.chatId ? data.chatId._serialized : null);\n      data = Object.assign({ event: event, session: client.session }, data);\n      if (req.serverOptions.mapper.enable) data = await convert(req.serverOptions.mapper.prefix, data);\n      api\n        .post(webhook, data)\n        .then(() => {\n          try {\n            const events = ['unreadmessages', 'onmessage'];\n            if (events.includes(event) && req.serverOptions.webhook.readMessage) client.sendSeen(chatId);\n          } catch (e) {}\n        })\n        .catch((e) => {\n          req.logger.warn('Error calling Webhook.', e);\n        });\n    } catch (e) {\n      req.logger.error(e);\n    }\n  }\n}\n\nasync function autoDownload(client, req, message) {\n  try {\n    if (message && (message['mimetype'] || message.isMedia || message.isMMS)) {\n      let buffer = await client.decryptFile(message);\n      if (req.serverOptions.webhook.uploadS3) {\n        var hashName = crypto.randomBytes(24).toString('hex');\n        var fileName = `${hashName}.${mime.extension(message.mimetype)}`;\n\n        const s3 = new aws.S3();\n\n        var params = {\n          Bucket: client.session,\n          Key: fileName,\n          Body: buffer,\n          ACL: 'public-read',\n          ContentType: message.mimetype,\n        };\n        const data = await s3.upload(params).promise();\n        message.fileUrl = data.Location;\n      } else {\n        message.body = await buffer.toString('base64');\n      }\n    }\n  } catch (e) {\n    req.logger.error(e);\n  }\n}\n\nexport async function startAllSessions(config, logger) {\n  try {\n    await api.post(`${config.host}:${config.port}/api/${config.secretKey}/start-all`);\n  } catch (e) {\n    logger.error(e);\n  }\n}\n\nexport async function startHelper(client, req) {\n  if (req.serverOptions.webhook.allUnreadOnStart) await sendUnread(client, req);\n\n  if (req.serverOptions.archive.enable) await archive(client, req);\n}\n\nasync function sendUnread(client, req) {\n  req.logger.info(`${client.session} : Inicio enviar mensagens não lidas`);\n\n  try {\n    const chats = await client.getAllChatsWithMessages(true);\n\n    if (chats && chats.length > 0) {\n      for (let i = 0; i < chats.length; i++)\n        for (let j = 0; j < chats[i].msgs.length; j++) {\n          callWebHook(client, req, 'unreadmessages', chats[i].msgs[j]);\n        }\n    }\n\n    req.logger.info(`${client.session} : Fim enviar mensagens não lidas`);\n  } catch (ex) {\n    req.logger.error(ex);\n  }\n}\n\nasync function archive(client, req) {\n  async function sleep(time) {\n    return new Promise((resolve) => setTimeout(resolve, time * 10));\n  }\n\n  req.logger.info(`${client.session} : Inicio arquivando chats`);\n\n  try {\n    let chats = await client.getAllChats();\n    if (chats && Array.isArray(chats) && chats.length > 0) {\n      chats = chats.filter((c) => !c.archive);\n    }\n    if (chats && Array.isArray(chats) && chats.length > 0) {\n      for (let i = 0; i < chats.length; i++) {\n        let date = new Date(chats[i].t * 1000);\n\n        if (DaysBetween(date) > req.serverOptions.archive.daysToArchive) {\n          await client.archiveChat(chats[i].id.id || chats[i].id._serialized, true);\n          await sleep(Math.floor(Math.random() * req.serverOptions.archive.waitTime + 1));\n        }\n      }\n    }\n    req.logger.info(`${client.session} : Fim arquivando chats`);\n  } catch (ex) {\n    req.logger.error(ex);\n  }\n}\n\nfunction DaysBetween(StartDate) {\n  let endDate = new Date();\n  // The number of milliseconds in all UTC days (no DST)\n  const oneDay = 1000 * 60 * 60 * 24;\n\n  // A day in UTC always lasts 24 hours (unlike in other time formats)\n  const start = Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());\n  const end = Date.UTC(StartDate.getFullYear(), StartDate.getMonth(), StartDate.getDate());\n\n  // so it's safe to divide by 24 hours\n  return (start - end) / oneDay;\n}\n\nexport function createFolders() {\n  const __dirname = path.resolve(path.dirname(''));\n  let dirFiles = path.resolve(__dirname, 'WhatsAppImages');\n  if (!fs.existsSync(dirFiles)) {\n    fs.mkdirSync(dirFiles);\n  }\n\n  let dirUpload = path.resolve(__dirname, 'uploads');\n  if (!fs.existsSync(dirUpload)) {\n    fs.mkdirSync(dirUpload);\n  }\n}\n\nexport function strToBool(s) {\n  return /^(true|1)$/i.test(s);\n}\n\nexport function getIPAddress() {\n  var interfaces = require('os').networkInterfaces();\n  for (var devName in interfaces) {\n    var iface = interfaces[devName];\n    for (var i = 0; i < iface.length; i++) {\n      var alias = iface[i];\n      if (alias.family === 'IPv4' && alias.address !== '127.0.0.1' && !alias.internal) return alias.address;\n    }\n  }\n  return '0.0.0.0';\n}\n\nexport function setMaxListners(serverOptions) {\n  if (serverOptions && Number.isInteger(serverOptions.maxListeners)) {\n    process.setMaxListeners(serverOptions.maxListeners);\n  }\n}\n\nexport let unlinkAsync = promisify(fs.unlink);\n\nexport function createCatalogLink(session) {\n  const [wid] = session.split('@');\n  return `https://wa.me/c/${wid}`;\n}\n"],"mappings":"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"}