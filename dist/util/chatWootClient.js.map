{"version":3,"file":"chatWootClient.js","names":["chatWootClient","constructor","config","session","mobile_name","mobile_number","sender","pushname","id","account_id","inbox_id","api","axios","create","baseURL","headers","api_access_token","token","eventEmitter","on","qrCode","urlCode","client","setTimeout","sendMessage","chatId","type","timestamp","mimetype","caption","replace","status","body","message","isGroupMsg","indexOf","contact","createContact","conversation","createConversation","split","extension","mime","filename","b64","buffer","decryptFile","toString","mediaData","Buffer","from","data","FormData","append","toStream","contentType","configPost","Object","assign","getHeaders","result","post","content","message_type","e","findContact","query","get","console","log","name","isMyContact","formattedName","phone_number","user","meta","count","payload","findConversation","find","source_id","contact_id"],"sources":["../../src/util/chatWootClient.js"],"sourcesContent":["/*\n * Copyright 2021 WPPConnect Team\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport axios from 'axios';\nimport { default as FormData } from 'form-data';\nimport mime from 'mime-types';\nimport toStream from 'buffer-to-stream';\nimport { eventEmitter } from './sessionUtil';\n\nexport default class chatWootClient {\n  constructor(config, session) {\n    this.config = config;\n    this.mobile_name = this.config.mobile_name ? this.config.mobile_name : `WPPConnect`;\n    this.mobile_number = this.config.mobile_number ? this.config.mobile_number : '5511999999999';\n    this.sender = {\n      pushname: this.mobile_name,\n      id: this.mobile_number,\n    };\n    this.account_id = this.config.account_id;\n    this.inbox_id = this.config.inbox_id;\n    this.api = axios.create({\n      baseURL: this.config.baseURL,\n      headers: { 'Content-Type': 'application/json;charset=utf-8', api_access_token: this.config.token },\n    });\n\n    //assina o evento do qrcode\n    eventEmitter.on(`qrcode-${session}`, (qrCode, urlCode, client) => {\n      setTimeout(async () => {\n        this.sendMessage(client, {\n          sender: this.sender,\n          chatId: this.mobile_number + '@c.us',\n          type: 'image',\n          timestamp: 'qrcode',\n          mimetype: 'image/png',\n          caption: 'leia o qrCode',\n          qrCode: qrCode.replace('data:image/png;base64,', ''),\n        });\n      }, 1000);\n    });\n\n    //assiona o evento do status\n    eventEmitter.on(`status-${session}`, (client, status) => {\n      this.sendMessage(client, {\n        sender: this.sender,\n        chatId: this.mobile_number + '@c.us',\n        body: `wppconnect status: ${status} `,\n      });\n    });\n\n    //assina o evento de mensagem\n    eventEmitter.on(`mensagem-${session}`, (client, message) => {\n      this.sendMessage(client, message);\n    });\n  }\n\n  async sendMessage(client, message) {\n    if (message.isGroupMsg || message.chatId.indexOf('@broadcast') > 0) return;\n    let contact = await this.createContact(message);\n    let conversation = await this.createConversation(contact, message.chatId.split('@')[0]);\n\n    try {\n      if (\n        message.type == 'image' ||\n        message.type == 'video' ||\n        message.type == 'in' ||\n        message.type == 'document' ||\n        message.type == 'ptt' ||\n        message.type == 'audio' ||\n        message.type == 'sticker'\n      ) {\n        if (message.mimetype == 'image/webp') message.mimetype = 'image/jpeg';\n        const extension = mime.extension(message.mimetype);\n        let filename = `${message.timestamp}.${extension}`;\n        let b64;\n\n        if (message.qrCode) b64 = message.qrCode;\n        else {\n          let buffer = await client.decryptFile(message);\n          b64 = await buffer.toString('base64');\n        }\n\n        let mediaData = Buffer.from(b64, 'base64');\n\n        let data = new FormData();\n        if (message.caption) {\n          data.append('content', message.caption);\n        }\n        data.append('attachments[]', toStream(mediaData), {\n          filename: filename,\n          contentType: message.mimetype,\n        });\n        data.append('message_type', 'incoming');\n        data.append('private', 'false');\n\n        let configPost = Object.assign(\n          {},\n          {\n            baseURL: this.config.baseURL,\n            headers: {\n              'Content-Type': 'application/json;charset=utf-8',\n              api_access_token: this.config.token,\n            },\n          }\n        );\n        configPost.headers = { ...configPost.headers, ...data.getHeaders() };\n\n        var result = await axios.post(\n          `api/v1/accounts/${this.account_id}/conversations/${conversation.id}/messages`,\n          data,\n          configPost\n        );\n\n        return result;\n      } else {\n        let body = {\n          content: message.body,\n          message_type: 'incoming',\n        };\n        const { data } = await this.api.post(\n          `api/v1/accounts/${this.account_id}/conversations/${conversation.id}/messages`,\n          body\n        );\n        return data;\n      }\n    } catch (e) {\n      return null;\n    }\n  }\n\n  async findContact(query) {\n    try {\n      const { data } = await this.api.get(`api/v1/accounts/${this.account_id}/contacts/search/?q=${query}`);\n      return data;\n    } catch (e) {\n      console.log(e);\n      return null;\n    }\n  }\n\n  async createContact(message) {\n    let body = {\n      inbox_id: this.inbox_id,\n      name: message.sender.isMyContact\n        ? message.sender.formattedName\n        : message.sender.pushname || message.sender.formattedName,\n      phone_number: typeof message.sender.id == 'object' ? message.sender.id.user : message.sender.id.split('@')[0],\n    };\n    body.phone_number = `+${body.phone_number}`;\n    var contact = await this.findContact(body.phone_number.replace('+', ''));\n    if (contact && contact.meta.count > 0) return contact.payload[0];\n\n    try {\n      const data = await this.api.post(`api/v1/accounts/${this.account_id}/contacts`, body);\n      return data.data.payload.contact;\n    } catch (e) {\n      console.log(e);\n      return null;\n    }\n  }\n\n  async findConversation(contact) {\n    try {\n      const { data } = await this.api.get(\n        `api/v1/accounts/${this.account_id}/conversations?inbox_id=${this.inbox_id}&status=all`\n      );\n      return data.data.payload.find((e) => e.meta.sender.id == contact.id && e.status != 'resolved');\n    } catch (e) {\n      console.log(e);\n      return null;\n    }\n  }\n\n  async createConversation(contact, source_id) {\n    var conversation = await this.findConversation(contact);\n    if (conversation) return conversation;\n\n    let body = {\n      source_id: source_id,\n      inbox_id: this.inbox_id,\n      contact_id: contact.id,\n      status: 'open',\n    };\n\n    try {\n      const { data } = await this.api.post(`api/v1/accounts/${this.account_id}/conversations`, body);\n      return data;\n    } catch (e) {\n      console.log(e);\n      return null;\n    }\n  }\n}\n"],"mappings":"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"}