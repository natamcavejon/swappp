{"version":3,"file":"auth.js","names":["formatSession","session","split","verifyToken","req","res","next","secureToken","serverOptions","secretKey","params","authorization","token","headers","status","send","message","tokenDecrypt","sessionDecrypt","replace","error","length","token_value","json","e","logger","bcrypt","compare","err","result","client","clientsArray"],"sources":["../../src/middleware/auth.js"],"sourcesContent":["/*\n * Copyright 2021 WPPConnect Team\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport bcrypt from 'bcrypt';\nimport { clientsArray } from '../util/sessionUtil';\n\nfunction formatSession(session) {\n  return session.split(':')[0];\n}\n\nconst verifyToken = (req, res, next) => {\n  const secureToken = req.serverOptions.secretKey;\n\n  const { session } = req.params;\n  const { authorization: token } = req.headers;\n  if (!session) return res.status(401).send({ message: 'Session not informed' });\n\n  try {\n    let tokenDecrypt = '';\n    let sessionDecrypt = '';\n\n    try {\n      sessionDecrypt = session.split(':')[0];\n      tokenDecrypt = session.split(':')[1].replace(/_/g, '/').replace(/-/g, '+');\n    } catch (error) {\n      try {\n        if (token && token !== '' && token.split(' ').length > 0) {\n          const token_value = token.split(' ')[1];\n          if (token_value) tokenDecrypt = token_value.replace(/_/g, '/').replace(/-/g, '+');\n          else return res.status(401).json({ message: 'Token is not present. Check your header and try again' });\n        } else {\n          return res.status(401).json({ message: 'Token is not present. Check your header and try again' });\n        }\n      } catch (e) {\n        req.logger.error(e);\n        return res.status(401).json({ error: 'Check that a Session and Token are correct', message: error });\n      }\n    }\n\n    bcrypt.compare(sessionDecrypt + secureToken, tokenDecrypt, function (err, result) {\n      if (result) {\n        req.session = formatSession(req.params.session);\n        req.token = tokenDecrypt;\n        req.client = clientsArray[req.session];\n        next();\n      } else {\n        return res.status(401).json({ error: 'Check that the Session and Token are correct' });\n      }\n    });\n  } catch (error) {\n    req.logger.error(error);\n    return res.status(401).json({\n      error: 'Check that the Session and Token are correct.',\n      message: error,\n    });\n  }\n};\n\nexport default verifyToken;\n"],"mappings":"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"}